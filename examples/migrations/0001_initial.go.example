package migrations

import (
	"gorm.io/gorm"
	"github.com/pankajredekar/goosegorm"
)

type InitialMigration struct{}

func (m InitialMigration) Version() string { return "20250101000000" }
func (m InitialMigration) Name() string    { return "initial" }

func (m InitialMigration) Up(db *gorm.DB) error {
	if sim, ok := any(db).(*goosegorm.SchemaBuilder); ok {
		// Simulation mode
		sim.CreateTable("users").
			AddColumnWithOptions("id", "uint", false, true, false).
			AddColumn("name", "string").
			AddColumnWithOptions("email", "string", false, false, true)
		return nil
	}

	// Real DB mode
	type User struct {
		ID    uint   `gorm:"primaryKey"`
		Name  string
		Email string `gorm:"uniqueIndex"`
	}
	return db.AutoMigrate(&User{})
}

func (m InitialMigration) Down(db *gorm.DB) error {
	if sim, ok := any(db).(*goosegorm.SchemaBuilder); ok {
		// Simulation mode
		sim.DropTable("users")
		return nil
	}

	// Real DB mode
	type User struct {
		ID    uint   `gorm:"primaryKey"`
		Name  string
		Email string `gorm:"uniqueIndex"`
	}
	return db.Migrator().DropTable(&User{})
}

func init() {
	goosegorm.RegisterMigration(InitialMigration{})
}
